# state.json schema – v1

This document describes the structure of the `state.json` file generated by the C++ fetcher (Sphere 1) and consumed by the Twitch bot (Sphere 2).

The file is a single JSON object with the following top-level keys:

- `meta`
- `room`
- `me`
- `archipelago`
- `checked_locations`
- `items`
- `data_storage`
- `messages`

---

## 1. meta

General information about the current state of the fetcher.

Object shape:

- `last_update` (number)
  - UNIX timestamp (float or int) of the last successful update from Archipelago.
- `connected` (boolean)
  - `true` if the fetcher is currently connected to the Archipelago server; `false` otherwise.
- `errors` (array of string)
  - Optional list of error messages or warnings encountered by the fetcher.

---

## 2. room

Information about the Archipelago room / session.

Object shape (fields may vary depending on the server):

- `seed_name` (string)
  - Name or identifier of the seed.
- `games` (array of string)
  - List of games present in the multiworld (for example: `["Archipelago", "Pokemon Emerald"]`).
- `tags` (array of string)
  - Tags associated with the room (for example: `["AP", "WebHost"]`).
- `hint_cost` (number)
  - Cost of hints in the current room (if applicable).
- `location_check_points` (number)
  - Number of points per checked location, if used.
- `location_count` (number, optional)
  - Total number of locations in the seed, when provided by the server.
- Other room-related fields may appear depending on Archipelago’s protocol and version.

---

## 3. me

Information about the current client / player slot.

Object shape:

- `slot_id` (number)
  - Internal slot ID assigned by the server.
- `slot_name` (string)
  - Name of the slot (for example: `LovenityJade`).
- `player_number` (number)
  - Player number within the multiworld.
- `team_id` (number)
  - Team ID if teams are used; usually `0` in solo games.
- `game` (string)
  - Name of the game for this slot (for example: `Pokemon Emerald`).

---

## 4. archipelago

Configuration and connection details related to Archipelago as seen by the bridge.

Object shape:

- `host` (string)
  - Hostname or IP address of the AP server (copied from config).
- `port` (number)
  - Port of the AP server (copied from config).
- `game` (string)
  - Game name, used as key inside the data package.
- `slot_name` (string)
  - Slot name used to log in.
- `password` (string)
  - Password used for this slot (may be empty).
- `server_version` (string, optional)
  - Version of the running Archipelago server, if known.
- `generator_version` (string, optional)
  - Version of the generator used for the seed, if provided.
- `total_locations_override` (number, optional)
  - Value coming from the config, used as fallback when `room.location_count` is missing or unreliable.

The exact contents can evolve, but these fields are the ones typically read by the bot.

---

## 5. checked_locations

A list of numeric location IDs that have been checked by this player.

- Type: array of number
- Example:
  - `[1000, 1001, 2000, 3005]`

The bot uses this array to compute progression for `!progress`.

---

## 6. items

A chronological list of items received by this player.

Each entry is an object with at least:

- `index` (number)
  - Monotonic index for ordering items as they are received.
- `item` (number)
  - Item ID as defined by the Archipelago data package.
- `location` (number)
  - Location ID where the item was placed.
- `player` (number)
  - Player ID who receives the item.
- `time` (number, optional)
  - Timestamp (or relative time) of when the item was received by the fetcher.

The bot uses this array for commands such as:

- `!lastitem` (last unique items and locations),
- `!keyitems` (filtering “important” items by name),
- auto-announcer when enabled.

---

## 7. data_storage

Data returned by Archipelago’s DataStorage and by the data package.

Object shape:

- `slot_data` (object)
  - Raw slot settings as provided by Archipelago for this player.
  - The `!rules` and `!flags` commands read this object to summarise:
    - goal,
    - randomization of badges, HMs, key items, bikes, rods, tickets,
    - overworld and hidden items,
    - NPC gifts and berry trees,
    - dexsanity / trainersanity,
    - flash requirements,
    - Elite Four / gym requirements,
    - DeathLink and other major flags.

- `data_package` (object)
  - Contains data package information.
  - Typically includes, per game:
    - `item_name_to_id` (object)
      - Mapping from item name (string) to item ID (number).
    - `location_name_to_id` (object)
      - Mapping from location name (string) to location ID (number).
  - The bot uses this to:
    - convert item IDs to human-readable names,
    - convert location IDs to human-readable location names.

- `storage` (object, optional)
  - Arbitrary key/value pairs read from Archipelago’s DataStorage using Get or SetNotify.
  - Example patterns:
    - `"Emerald/CurrentMapId": 42`
    - `"Emerald/Badges": 3`

---

## 8. messages

A list of recent messages or packets coming from Archipelago, for debugging or advanced features.

- Type: array of object
- Each entry typically contains:
  - `time` (number)
    - Timestamp at which the message was received.
  - `type` (string)
    - Type of message (for example: `"PrintJSON"` or other Archipelago packet types).
  - `payload` (object)
    - Raw JSON payload for this message.

The fetcher usually keeps only the last N messages in memory; this limit is controlled by `config.fetcher.max_messages_memory` in the config file.

---

## Versioning

This document describes `state.json` version 1 (v1) as produced by the current BETA of the fetcher.

- New fields may be added in the future.
- Existing fields should remain stable to avoid breaking the Twitch bot.
- If a breaking change is required, the version number should be bumped and documented here.

